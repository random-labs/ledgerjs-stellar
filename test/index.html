<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/0.8.0/stellar-sdk.js"></script>
    <script src="../browser/ledgerjs-stellar.js"></script>
    <script src="../browser/test.js"></script>
    <script>
        let transport = null;
        let api = null;
        function getPublicKey(confirm) {
          let bip32Path = document.getElementById('bip32Path').value;
          connect().then(function () {
            api.getPublicKey(bip32Path, true, confirm).then(function (result) {
              document.getElementById('address').innerHTML = result.publicKey;
            }).catch(function (error) {
              document.getElementById('address').innerHTML = error;
            });
          });
        }
        function selectAndRun() {
            let select = document.getElementById('operation');
            let operation = select.options[select.selectedIndex].text;
            runScript('signTx', operation);
        }
        function doConnect() {
          displayStatus('Connect ledger');
          return LedgerjsStellar.Transport.create(3600000).then(function (t) {
            transport = t;
            transport.setDebugMode(true);
            api = new LedgerjsStellar.Api(transport);
            displayStatus('Connected');
          }).catch(function () {
            displayStatus('Error connecting');
          });
        }
        function connect() {
          if (api !== null) {
            return api.getAppConfiguration().catch(function () {
              api = null;
              return doConnect();
            });
          } else {
            return doConnect();
          }
        }
        function displayStatus(msg) {
          document.getElementById('status').innerHTML = msg;
        }
    </script>
</head>
<body onload="connect()">
<div id="status"></div>
<div>&nbsp;</div>
<div id="addressForm">
  <input type="text" id="bip32Path" value="44'/148'/0'">
  <input id='getPublicKey' type="button" onClick="getPublicKey(false)" value="Get Public Key">
  <input id='confirmPublicKey' type="button" onClick="getPublicKey(true)" value="Confirm Public Key">
</div>
<div>&nbsp;</div>
<div id="address">&nbsp;</div>
<div>&nbsp;</div>
<div id="form">
    <select id="operation">
        <option>createAccount</option>
        <option>payment</option>
        <option>pathPayment</option>
        <option>createOffer</option>
        <option>removeOffer</option>
        <option>changeOffer</option>
        <option>passiveOffer</option>
        <option>changeTrust</option>
        <option>removeTrust</option>
        <option>allowTrust</option>
        <option>revokeTrust</option>
        <option>setOptions</option>
        <option>accountMerge</option>
        <option>manageData</option>
        <option>inflation</option>
    </select>
    <input id='signTx' type="button" onClick="selectAndRun()" value="Sign">
</div>
</body>
</html>
