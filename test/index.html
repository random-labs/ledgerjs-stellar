<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/0.8.0/stellar-sdk.js"></script>
    <script src="../browser/ledgerjs-stellar.js"></script>
    <script src="operations.js"></script>
    <script>

        const openTimeout = 3600000;
        const exchangeTimeout = 10 * 1000;
        let _api = null;
        let _appVersion = null;

        function getPublicKey(confirm) {
          let bip32Path = document.getElementById('bip32Path').value;
          return connect().then(function (api) {
            const msg = confirm ? 'Confirm public key...' : 'Getting public key...';
            displayStatus(msg);
//            disableControls(true);
            return api.getPublicKey(bip32Path, true, confirm).then((result) => {
              displayAddress(result.publicKey);
              displayStatus('Received public key');
//              disableControls(false);
              return result.publicKey;
            }).catch((error) => {
              displayStatus('Failed to get public key: ' + error);
              throw error;
            });
          });
        }

        function sign() {
          let select = document.getElementById('operation');
          let operation = select.options[select.selectedIndex].text;
          signTransaction(operations[operation]);
        }

        function loadAccount(publicKey) {
          const server = new StellarSdk.Server('https://horizon-testnet.stellar.org');
          return server.loadAccount(publicKey);
        }

        function signTransaction(operation) {
            getPublicKey(false).then((publicKey) => {
                displayStatus('Loading account data...');
                loadAccount(publicKey).then((account) => {
                  const transaction = operation(account);
                  connect().then((api) => {
                    StellarSdk.Network.useTestNetwork();
                    let bip32Path = document.getElementById('bip32Path').value;
                    displayStatus('Signing transaction...');
//                    disableControls(true);
                    api.signTransaction(bip32Path, transaction.signatureBase()).then((result) => {
                      const txHash = transaction.hash();
                      const keyPair = StellarSdk.Keypair.fromPublicKey(publicKey);
                      if (keyPair.verify(txHash, result.signature)) {
                        displayStatus('Transaction signed');
                      } else {
                        displayStatus('Bad signature');
                      }
                      displaySignature(result.signature.toString('hex'));
//                      disableControls(false);
                    }).catch(function (err) {
                      displayStatus(err);
                    });
                  });
                });
            });
        }

        function open() {
          displayStatus('Opening');
          return LedgerjsStellar.Transport.create(openTimeout).then((transport) => {
            transport.setDebugMode(true);
            transport.setExchangeTimeout(exchangeTimeout);
            _api = new LedgerjsStellar.Api(transport);
            displayStatus('Opened');
            return _api;
          }).catch((err) => {
            displayStatus('Error opening: ' + err);
          });
        }

        function connect() {
          if (_api === null) {
            return open().then((api) => {
              return api.getAppConfiguration().then((result) => {
                _appVersion = result.version;
                displayStatus('Connected (app version ' + _appVersion + ')');
                return api;
              });
            });
          } else {
            return _api.getAppConfiguration().then((result) => {
              _appVersion = result.version;
              displayStatus('Connected (app version ' + _appVersion + ')');
              return _api;
            }).catch((err) => {
              _api = null;
              console.log(err);
              return connect();
            });
          }
        }

        function displayStatus(msg) {
          console.log(msg);
          document.getElementById('status').innerHTML = msg;
        }

        function displayAddress(address) {
          document.getElementById('address').innerHTML = address;
        }

        function displaySignature(signature) {
          document.getElementById('signature').innerHTML = signature;
        }

        function init() {
          connect().then(function () {
            disableControls(false);
          })
        }

        function disableControls(disable) {
          const inputs = document.getElementsByTagName('input');
          const confirmPkEnabled = Number(_appVersion.substring(0, _appVersion.indexOf('.'))) >= 2;
          for(let i = 0; i < inputs.length; i++){
            if (inputs[i].id === 'confirmPublicKey' && !confirmPkEnabled) {
              continue;
            }
            inputs[i].disabled = disable;
          }
        }

    </script>
</head>
<body onload="init()">
<div>Status: <span id="status" style="font-family: monospace; font-size: 15px;"></span></div>
<!--<div>&nbsp;</div>-->
<!--<div id="connectForm">-->
    <!--<input id='connect' type="button" onClick="connect()" value="Connect" disabled>-->
<!--</div>-->
<div>&nbsp;</div>
<div id="addressForm">
  <input type="text" id="bip32Path" value="44'/148'/0'" disabled>
  <input id='getPublicKey' type="button" onClick="getPublicKey(false)" value="Get Public Key" disabled>
  <input id='confirmPublicKey' type="button" onClick="getPublicKey(true)" value="Confirm Public Key" disabled>
</div>
<div>&nbsp;</div>
<div>Public Key: <span id="address" style="font-family: monospace; font-size: 15px;"></span></div>
<div>&nbsp;</div>
<div id="form">
    <select id="operation">
        <option>createAccount</option>
        <option>payment</option>
        <option>pathPayment</option>
        <option>createOffer</option>
        <option>removeOffer</option>
        <option>changeOffer</option>
        <option>passiveOffer</option>
        <option>changeTrust</option>
        <option>removeTrust</option>
        <option>allowTrust</option>
        <option>revokeTrust</option>
        <option>setOptions</option>
        <option>accountMerge</option>
        <option>manageData</option>
        <option>inflation</option>
    </select>
    <input id='signTx' type="button" onClick="sign()" value="Sign" disabled>
</div>
<div>&nbsp;</div>
<div>Signature: <span id="signature" style="font-family: monospace; font-size: 15px;"></span></div>
</body>
</html>
