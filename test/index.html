<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/0.8.0/stellar-sdk.js"></script>
    <script src="../browser/ledgerjs-stellar.js"></script>
    <script src="operations.js"></script>
    <script>
        const openTimeout = 3600000; // one hour
        const exchangeTimeout = 3600000; // one hour
        let _api = null;

        function getPublicKey(confirm) {
          let bip32Path = document.getElementById('bip32Path').value;
          return connect().then(function (api) {
            displayStatus('Getting public key...');
            return api.getPublicKey(bip32Path, true, confirm).then(function (result) {
              displayAddress(result.publicKey);
              displayStatus('Received public key');
              return result.publicKey;
            }).catch(function (error) {
              displayStatus('Failed to get public key: ' + error);
            });
          });
        }

        function sign() {
          let select = document.getElementById('operation');
          let operation = select.options[select.selectedIndex].text;
          signTransaction(operations[operation]);
        }

        function loadAccount(publicKey) {
          const server = new StellarSdk.Server('https://horizon-testnet.stellar.org');
          return server.loadAccount(publicKey);
        }

        function signTransaction(operation) {
            getPublicKey(false).then(function (publicKey) {
                displayStatus('Loading account data...');
                loadAccount(publicKey).then(function (account) {
                  const transaction = operation(account);
                  connect().then(function (api) {
                    StellarSdk.Network.useTestNetwork();
                    let bip32Path = document.getElementById('bip32Path').value;
                    displayStatus('Signing transaction...');
                    api.signTransaction(bip32Path, transaction.signatureBase()).then(function (result) {
                      const txHash = transaction.hash();
                      const keyPair = StellarSdk.Keypair.fromPublicKey(publicKey);
                      if (keyPair.verify(txHash, result.signature)) {
                        displayStatus('Transaction signed');
                      } else {
                        displayStatus('Bad signature');
                      }
                    }).catch(function () {
                      displayStatus('Failed to sign transaction');
                    });
                  });
                }).catch(function () {
                  displayStatus('Failed to load account data');
                });
            });
        }

        function doConnect() {
          displayStatus('Connecting');
          return LedgerjsStellar.Transport.create(openTimeout).then(function (transport) {
            transport.setDebugMode(true);
            transport.setExchangeTimeout(exchangeTimeout);
            _api = new LedgerjsStellar.Api(transport);
            displayStatus('Connected');
            return _api;
          }).catch(function () {
            displayStatus('Error connecting');
          });
        }

        function connect() {
          if (_api !== null) {
            displayStatus('Connecting');
            return _api.getAppConfiguration().then(function () {
              displayStatus('Connected');
              return _api;
            }).catch(function () {
              _api = null;
              return doConnect();
            });
          } else {
            return doConnect();
          }
        }

        function displayStatus(msg) {
          document.getElementById('status').innerHTML = msg;
        }

        function displayAddress(msg) {
          document.getElementById('address').innerHTML = msg;
        }

        function init() {
          connect().then(function () {
            const inputs = document.getElementsByTagName('input');
            for(let i = 0; i < inputs.length; i++){
              inputs[i].disabled = false;
            }
          })
        }

    </script>
</head>
<body onload="init()">
<div>Status: <span id="status" style="background-color: lightgray"></span></div>
<div>&nbsp;</div>
<div id="addressForm">
  <input type="text" id="bip32Path" value="44'/148'/0'" disabled>
  <input id='getPublicKey' type="button" onClick="getPublicKey(false)" value="Get Public Key" disabled>
  <input id='confirmPublicKey' type="button" onClick="getPublicKey(true)" value="Confirm Public Key" disabled>
</div>
<div>&nbsp;</div>
<div id="address">&nbsp;</div>
<div>&nbsp;</div>
<div id="form">
    <select id="operation">
        <option>createAccount</option>
        <option>payment</option>
        <option>pathPayment</option>
        <option>createOffer</option>
        <option>removeOffer</option>
        <option>changeOffer</option>
        <option>passiveOffer</option>
        <option>changeTrust</option>
        <option>removeTrust</option>
        <option>allowTrust</option>
        <option>revokeTrust</option>
        <option>setOptions</option>
        <option>accountMerge</option>
        <option>manageData</option>
        <option>inflation</option>
    </select>
    <input id='signTx' type="button" onClick="sign()" value="Sign" disabled>
</div>
</body>
</html>
